# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import logging # –î–ª—è –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã (–ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –∏ —Å–æ–±—ã—Ç–∏—è)
from telegram import Update # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
from telegram.ext import Application, MessageHandler, filters, ContextTypes # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ Telegram
from telegram.helpers import escape_markdown # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è Telegram-—Å–æ–æ–±—â–µ–Ω–∏–π
import requests # HTTP-–∑–∞–ø—Ä–æ—Å—ã –∫ API
import json # –†–∞–±–æ—Ç–∞ —Å JSON-–¥–∞–Ω–Ω—ã–º–∏
import ollama # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ LLM (Large Language Model)
from bs4 import BeautifulSoup # –ü–∞—Ä—Å–∏–Ω–≥ HTML/XML –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
from bs4 import XMLParsedAsHTMLWarning # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ BeautifulSoup
import warnings # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏
import asyncio # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
from urllib.parse import urlparse # –ü–∞—Ä—Å–∏–Ω–≥ URL
import time # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –∏ –∏–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
from random import uniform # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ñ–ª—É–¥–∞

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–≤–æ–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
from config import (
    TELEGRAM_TOKEN, 
    YANDEX_USER,
    YANDEX_API_KEY,
    YANDEX_FOLDER_ID,
    YANDEX_SEARCH_URL
) # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è Telegram –∏ Yandex Search API

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Ollama
ollama.pull('yandex/YandexGPT-5-Lite-8B-instruct-GGUF') # –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ LLM –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–∫—Ç–æ–≤

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
) # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã
logger = logging.getLogger(__name__) # –õ–æ–≥–≥–µ—Ä –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–æ–¥—É–ª—è

# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è XMLParsedAsHTMLWarning
warnings.filterwarnings('ignore', category=XMLParsedAsHTMLWarning) # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ HTML

def handle_api_error(code: str, message: str) -> list:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ API"""
    error_map = {
        '42': '–ù–µ–≤–µ—Ä–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
        '32': '–ü—Ä–µ–≤—ã—à–µ–Ω–∞ –∫–≤–æ—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤',
        '55': '–ü—Ä–µ–≤—ã—à–µ–Ω–æ RPS-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ',
        '15': '–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞'
    } # –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫ —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
    
    return [{
        'title': error_map.get(code, '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API'),
        'url': 'https://yandex.cloud/ru/docs/search-api/reference/error-codes',
        'snippet': f'–ö–æ–¥ {code}: {message}'
    }] # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å –æ—à–∏–±–∫–æ–π –∏ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

async def analyze_facts(text: str) -> dict:
    """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å –ø–æ–º–æ—â—å—é LLM"""
    prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–æ–≤–æ—Å—Ç–Ω–æ–π —Ç–µ–∫—Å—Ç –∏ –≤—ã–¥–µ–ª–∏ –∏–∑ –Ω–µ–≥–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —Ñ–∞–∫—Ç—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏.

–ò–ù–°–¢–†–£–ö–¶–ò–ò:
1. –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: –ß–¢–û –ø—Ä–æ–∏–∑–æ—à–ª–æ, –ì–î–ï, –ö–û–ì–î–ê, –ö–¢–û —É—á–∞—Å—Ç–≤–æ–≤–∞–ª/—Å–æ–æ–±—â–∏–ª, –∏ –ª—é–±—ã–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏.
2. –í–∫–ª—é—á–∞–π –≤ —Ñ–∞–∫—Ç—ã –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã (–¥–∞—Ç—É, –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è).
3. –°–æ—Ö—Ä–∞–Ω—è–π —á–∏—Å–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –∏–º–µ–Ω–∞, –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π, –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è.
4. –§–æ—Ä–º—É–ª–∏—Ä—É–π —Ñ–∞–∫—Ç—ã –∫–∞–∫ –∑–∞–∫–æ–Ω—á–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –ø–æ–Ω—è—Ç–Ω—ã–µ –≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏—Å—Ö–æ–¥–Ω–æ–π —Å—Ç–∞—Ç—å–∏.
5. –ù–µ –≤–∫–ª—é—á–∞–π –æ—Ü–µ–Ω–æ—á–Ω—ã–µ —Å—É–∂–¥–µ–Ω–∏—è –∏–ª–∏ –º–Ω–µ–Ω–∏—è, —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.

–ü–†–ò–ú–ï–† –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è (—Å–ª–∏—à–∫–æ–º –º–∞–ª–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):
"–ù–µ—Å–∫–æ–ª—å–∫–æ –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–π –ø—Ä–æ–∏–∑–æ—à–ª–∏ —Å–µ–≥–æ–¥–Ω—è"
"–°–∞–º–æ–µ —Å–∏–ª—å–Ω–æ–µ –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤ 11:27 –º—Å–∫"

–ü–†–ò–ú–ï–† –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è (—Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º):
"–ù–µ—Å–∫–æ–ª—å–∫–æ –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–π –ø—Ä–æ–∏–∑–æ—à–ª–∏ [–¥–∞—Ç–∞] –≤ —Ä–∞–π–æ–Ω–µ –≤–æ–¥–æ–ø–∞–¥–∞ –£—á–∞–Ω-–°—É –≤ –ö—Ä—ã–º—É, —Å–æ–≥–ª–∞—Å–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏—é –†–ò–ê –ù–æ–≤–æ—Å—Ç–∏ –ö—Ä—ã–º"
"–°–∞–º–æ–µ —Å–∏–ª—å–Ω–æ–µ –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–µ –≤ —Ä–∞–π–æ–Ω–µ –≤–æ–¥–Ω—è–∫–∞ –£—á–∞–Ω-–°—É –≤ –ö—Ä—ã–º—É [–¥–∞—Ç–∞] –ø—Ä–æ–∏–∑–æ—à–ª–æ –≤ 11:27 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏, –ø–æ –¥–∞–Ω–Ω—ã–º –∑–∞–º–¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –ò–Ω—Å—Ç–∏—Ç—É—Ç–∞ —Å–µ–π—Å–º–æ–ª–æ–≥–∏–∏ –∏ –≥–µ–æ–¥–∏–Ω–∞–º–∏–∫–∏ –ú–∞—Ä–∏–Ω—ã –ë–æ–Ω–¥–∞—Ä—å"

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π:
{{
    "facts": ["–ø–æ–ª–Ω—ã–π —Ñ–∞–∫—Ç 1", "–ø–æ–ª–Ω—ã–π —Ñ–∞–∫—Ç 2", ...]
}}

–¢–µ–∫—Å—Ç: {text[:1500]}
"""
    logger.info(f"LLM Fact Extraction Prompt: {text[:1500]!r}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    try:
        resp = ollama.generate(
            model='yandex/YandexGPT-5-Lite-8B-instruct-GGUF',
            prompt=prompt,
            format='json',
            options={'temperature': 0.1, 'num_ctx': 8192}
        ) # –í—ã–∑–æ–≤ LLM —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        raw = resp['response'].strip().replace('```json', '').replace('```', '') # –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ JSON
        try:
            return json.loads(raw) # –ü–∞—Ä—Å–∏–Ω–≥ JSON-–æ—Ç–≤–µ—Ç–∞
        except json.JSONDecodeError:
            import json_repair # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è JSON
            return json.loads(json_repair.repair_json(raw)) # –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å JSON
    except Exception as err:
        logger.error(f"–û—à–∏–±–∫–∞ analyze_facts: {err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        return {"facts": []} # –í–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Ñ–∞–∫—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

async def yandex_factcheck(fact: str) -> list:
    """–ü–æ–∏—Å–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ Yandex Search API"""
    try:
        original_fact = fact
        logger.info(f"–ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–∫—Ç: '{original_fact}'") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–∫—Ç–∞
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º XML –∑–∞–ø—Ä–æ—Å —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        request_xml = f"""<?xml version="1.0" encoding="UTF-8"?>
        <request>
            <query>{original_fact}</query>
            <page>0</page>
            <sortby order="descending">rlv</sortby>
            <maxpassages>2</maxpassages>
            <groupings>
                <groupby attr="d" mode="deep" groups-on-page="5" docs-in-group="1"/>
            </groupings>
        </request>
        """
        
        # –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        params = {
            'folderid': YANDEX_FOLDER_ID,  # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–∞—Ç–∞–ª–æ–≥–∞
            'apikey': YANDEX_API_KEY,      # API-–∫–ª—é—á —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
            'type': 'xml'                  # –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
        }
        
        headers = {
            'Content-Type': 'application/xml',
            'Accept': 'application/xml'
        }

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π API endpoint
        api_url = 'https://yandex.ru/search/xml' # URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
        
        logger.info(f"–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Yandex Search API: {original_fact[:50]}...") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
        await asyncio.sleep(uniform(0.5, 1.5)) # –†–∞–Ω–¥–æ–º–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ñ–ª—É–¥–∞
        
        response = requests.post(
            api_url,
            params=params,
            data=request_xml.encode('utf-8'),
            headers=headers,
            timeout=15
        ) # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API
        
        response.raise_for_status() # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏ HTTP
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
        xml_soup = BeautifulSoup(response.text, 'xml') # –ü–∞—Ä—Å–∏–Ω–≥ XML
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API
        if error := xml_soup.find('error'):
            error_code = error.get('code', 'unknown')
            logger.error(f"–û—à–∏–±–∫–∞ API (–∫–æ–¥ {error_code}): {error.text}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ API
            return handle_api_error(error_code, error.text) # –í–æ–∑–≤—Ä–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–π –æ—à–∏–±–∫–∏
        
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        results = []
        for doc in xml_soup.find_all('doc'):
            try:
                url = doc.find('url').text.strip()
                title = doc.find('title').text.strip() if doc.find('title') else "–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞"
                snippet = ' '.join([p.text for p in doc.find_all('passage')][:2]) # –û–±—Ä–µ–∑–∞–Ω–∏–µ –æ—Ç—Ä—ã–≤–∫–æ–≤
        
                results.append({
                    'title': title[:200],
                    'url': url,
                    'snippet': snippet[:400]
                })
            except Exception as doc_err:
                logger.warning(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {doc_err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

        return results if results else [{
            'title': '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞',
            'url': '',
            'snippet': f'–ü–æ –∑–∞–ø—Ä–æ—Å—É "{original_fact}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'
        }] # –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–µ—É–¥–∞—á–µ
        
    except Exception as err:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {err}", exc_info=True) # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
        return [{
            'title': '–û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã',
            'url': '',
            'snippet': '–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ'
        }] # –í–æ–∑–≤—Ä–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Å–∏—Å—Ç–µ–º–Ω–æ–π –æ—à–∏–±–∫–µ

async def analyze_news_text(text: str) -> str:
    """–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–æ–≤–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏, –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ –∏ —Ç.–¥."""
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    truncated_text = text[:1000] + ("..." if len(text) > 1000 else "") # –û–±—Ä–µ–∑–∫–∞ –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    
    prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏ –∏ –æ—Ü–µ–Ω–∏ –µ–≥–æ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º:
1. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –æ–∫—Ä–∞—Å–∫–∞ –∏ —è–∑—ã–∫ (–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –∏–ª–∏ –º–∞–Ω–∏–ø—É–ª—è—Ç–∏–≤–Ω—ã–π)
2. –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—Å—Ç–∞
3. –ù–∞–ª–∏—á–∏–µ/–æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏ (–¥–∞—Ç—ã, –∏–º–µ–Ω–∞, —Ü–∏—Ñ—Ä—ã)
4. –°—Å—ã–ª–∫–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏, (–µ—Å—Ç—å –∏–ª–∏ –Ω–µ—Ç, –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∏–ª–∏ –Ω–µ—Ç) –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–∏–ª—å–Ω–æ —Å–Ω–∏–∂–∞—Ç—å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å, –æ–Ω–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –æ–±–±–Ω–∞—Ä—É–∂–µ–Ω—ã –≤ —Ä–µ–∑–ª—å—Ç–∞—Ç–µ –ø–æ–∏—Å–∫–∞ –≤ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç
5. –ë–∞–ª–∞–Ω—Å —Ç–æ—á–µ–∫ –∑—Ä–µ–Ω–∏—è (–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∏–ª–∏ –æ–¥–Ω–æ–±–æ–∫–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ)

–î–∞–π –∫—Ä–∞—Ç–∫—É—é –æ—Ü–µ–Ω–∫—É –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (–Ω–µ –±–æ–ª–µ–µ 200 —Å–ª–æ–≤).

–¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏: {truncated_text}
"""
    try:
        resp = ollama.generate(
            model='yandex/YandexGPT-5-Lite-8B-instruct-GGUF',
            prompt=prompt,
            options={'temperature': 0.1, 'num_ctx': 8192}
        )
        result = remove_thinking_tags(resp['response']) # –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –º—ã—à–ª–µ–Ω–∏—è
        return result
    except Exception as err:
        logger.error(f"–û—à–∏–±–∫–∞ analyze_news_text: {err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        return "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–æ–≤–æ—Å—Ç–∏." # –í–æ–∑–≤—Ä–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ

def remove_thinking_tags(text):
    """–£–¥–∞–ª—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–µ–∂–¥—É —Ç–µ–≥–∞–º–∏ """
    import re
    pattern = r'{<think>.*?</think>' # –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –º—ã—à–ª–µ–Ω–∏—è
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º re.DOTALL, —á—Ç–æ–±—ã —Ç–æ—á–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ —Ç–∞–∫–∂–µ —Å–∏–º–≤–æ–ª–∞–º –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
    cleaned_text = re.sub(pattern, '', text, flags=re.DOTALL)
    return cleaned_text

async def generate_report(facts: list, results: dict) -> str:
    """–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ —Å –ø–æ–º–æ—â—å—é LLM"""
    data_str = json.dumps(results, ensure_ascii=False, indent=2)
    logger.info(f"LLM Report Data: {data_str}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    prompt = f"""
–¢—ã –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç –æ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤.

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê:
–°–æ–∑–¥–∞–π –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –ë–ï–ó –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–∏–º–≤–æ–ª—ã *, _, [, ], (, ), ~, `, >, #, +, -, =, |, {{, }}, ., ! –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
–£–±–µ—Ä–µ—Ä–∏ –∏–µ—Ä–æ–≥–ª–∏—Ñ—ã –∏–∑ –æ—Ç–≤–µ—Ç–∞.
–û–≥—Ä–∞–Ω–∏—á—å –æ–±—â–∏–π –æ–±—ä–µ–º –æ—Ç–≤–µ—Ç–∞ –≤ 3000 —Å–∏–º–≤–æ–ª–æ–≤.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç—á–µ—Ç–∞:
- –î–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å: X –∏–∑ 100

- –ü—Ä–∏—á–∏–Ω—ã (—Å–ø–∏—Å–æ–∫ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø—É–Ω–∫—Ç–æ–≤)

- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤)

- –í—ã–≤–æ–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö

–ù–ï –≤–∫–ª—é—á–∞–π —Ç–µ–≥–∏ üß† –∏–ª–∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ HTML-—Ç–µ–≥–∏ –≤ —Å–≤–æ–π –æ—Ç–≤–µ—Ç.
–ù–ï —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ MarkdownV2 –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ç–µ–∫—Å—Ç–µ –æ—Ç–≤–µ—Ç–∞.

–î–∞–Ω–Ω—ã–µ: {data_str}
"""
    try:
        resp = ollama.generate(
            model='yandex/YandexGPT-5-Lite-8B-instruct-GGUF',
            prompt=prompt,
            options={'temperature': 0.1, 'num_ctx': 8192}
        )
        response_text = resp['response']
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–µ–∂–¥—É —Ç–µ–≥–∞–º–∏ <think> –∏< /think>
        clean_response = remove_thinking_tags(response_text)
        
        return clean_response
    except Exception as err:
        logger.error(f"–û—à–∏–±–∫–∞ generate_report: {err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á—ë—Ç." # –í–æ–∑–≤—Ä–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ

def is_meaningful_text(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞"""
    clean_text = re.sub(r'\s+', ' ', re.sub(r'[^\w\s]', '', text)).strip() # –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –æ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
    return (
        len(clean_text) >= 16 and # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞
        len(set(clean_text.split())) >= 4 and # –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å–ª–æ–≤
        any(c.isalpha() for c in clean_text) # –ù–∞–ª–∏—á–∏–µ –±—É–∫–≤
    )

async def anti_flood(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞—â–∏—Ç—ã –æ—Ç —Ñ–ª—É–¥–∞"""
    user_id = update.effective_user.id
    
    if not flood_control.check_user(user_id): # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–ª—É–¥ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
        logger.warning(f"–§–ª—É–¥-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        await update.message.reply_text("‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç.")
        return True  # –ë–ª–æ–∫–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
    return False  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∏ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        user_text = update.message.text or update.message.caption

        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –ø–æ–¥–ø–∏—Å–∏ –∫ –º–µ–¥–∏–∞
        user_text = (
            update.message.text or 
            update.message.caption or 
            ''
        ).strip()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ–∫—Å—Ç–∞
        if not user_text:
            logger.debug("–ú–µ–¥–∏–∞-—Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –æ—Ç %s", update.effective_user.id)
            return

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞
        text_length = len(user_text)
        if text_length < 6:
            logger.debug("–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –≤ –º–µ–¥–∏–∞-—Å–æ–æ–±—â–µ–Ω–∏–∏ –æ—Ç %s", update.effective_user.id)
            return

        if len(user_text) > 1500:
            user_text = user_text[:1500] + "..." # –û–±—Ä–µ–∑–∫–∞ –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞

        logger.info(f"Received from {update.effective_user.id}: {user_text[:120]!r}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è

        processing_message = await update.message.reply_text("‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...")

        try:
            await context.bot.edit_message_text(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id,
                text="‚è≥ –í—ã–ø–æ–ª–Ω—è—é –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤..."
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        
        text_analysis_task = asyncio.create_task(analyze_news_text(user_text)) # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞
        facts_data = await analyze_facts(user_text)
        facts = facts_data.get('facts', [])[:5] # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ–∞–∫—Ç–æ–≤
        
        # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–∫—Ç–æ–≤
        try:
            await context.bot.edit_message_text(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id,
                text="‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã..."
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")
        
        fact_results = {fact: await yandex_factcheck(fact) for fact in facts} # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏
        
        # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞
        try:
            await context.bot.edit_message_text(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id,
                text="‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–µ–∫—Å—Ç..."
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")
            
        # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–¥–∞—á–∏ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞ - –î–û–ë–ê–í–õ–ï–ù–û
        text_analysis = await text_analysis_task
        
        # –û—Ü–µ–Ω–∏–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        try:
            await context.bot.edit_message_text(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id,
                text="‚è≥ –û—Ü–µ–Ω–∏–≤–∞—é –∫–∞—á–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤..."
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")

        sources_quality_task = asyncio.create_task(evaluate_sources_quality(fact_results)) # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –æ—Ü–µ–Ω–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–∞–∫—Ç–æ–≤ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
        try:
            await context.bot.edit_message_text(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id,
                text="‚è≥ –í—ã–ø–æ–ª–Ω—è—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–∞–∫—Ç–æ–≤ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö..."
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")

        factcheck_task = asyncio.create_task(perform_factchecking(user_text, facts, fact_results)) # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–∫—Ç–æ–≤
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
        sources_quality = await sources_quality_task
        factcheck_results = await factcheck_task
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ—Ü–µ–Ω–∫—É
        try:
            await context.bot.edit_message_text(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id,
                text="‚è≥ –§–æ—Ä–º–∏—Ä—É—é –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ—Ü–µ–Ω–∫—É..."
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")

        comprehensive_report = await generate_comprehensive_assessment(
            text_analysis, facts, fact_results, sources_quality, factcheck_results
        ) # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞
        
        # –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–∫—Ç–æ–≤
        factcheck_info = "\n üìë –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–†–û–í–ï–†–ö–ò –§–ê–ö–¢–û–í:\n"
        if "factcheck_results" in factcheck_results:
            for fact_check in factcheck_results["factcheck_results"]:
                fact = fact_check.get("fact", "")
                status = fact_check.get("confirmation_status", "")
                explanation = fact_check.get("explanation", "")
                factcheck_info += f"‚Ä¢ {fact[:120]}{'...' if len(fact) > 120 else ''}\n"
                factcheck_info += f"  –°—Ç–∞—Ç—É—Å: {status}\n"
                factcheck_info += f"  –ü–æ—è—Å–Ω–µ–Ω–∏–µ: {explanation}\n\n"
        
        # –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
        sources_info = "üîó –ò–°–¢–û–ß–ù–ò–ö–ò –§–ê–ö–¢–û–í:\n"
        for fact, sources in fact_results.items():
            sources_info += f"‚Ä¢ {fact[:120]}{'...' if len(fact) > 120 else ''}\n"
            
            if not sources:
                sources_info += "  - –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã\n"
            else:
                for src in sources[:1]:
                    title = src.get('title', '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞')
                    url = src.get('url', '')
                    sources_info += f"  - {title[:120]}{'...' if len(title) > 120 else ''}: {url[:120]}\n\n"
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç
        final_report = "\n".join([
            comprehensive_report[:1330],
            factcheck_info[:1330],
            sources_info[:1330]
        ]) # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —á–∞—Å—Ç–µ–π –æ—Ç—á—ë—Ç–∞
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
        try:
            await context.bot.delete_message(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ: {e}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç
        await send_long_message(update, final_report) # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    except Exception as err:
        logger.error(f"–û—à–∏–±–∫–∞ handle_message: {err}", exc_info=True) # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.")

async def send_long_message(update, text):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, —Å–æ–∫—Ä–∞—â–∞—è –µ–≥–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
    MAX_MESSAGE_LENGTH = 4000  # –ù–µ–º–Ω–æ–≥–æ –º–µ–Ω—å—à–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ –¥–ª—è –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏
    
    # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–æ—á–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ —Ü–µ–ª–∏–∫–æ–º
    if len(text) <= MAX_MESSAGE_LENGTH:
        return await update.message.reply_text(text)
    
    # –°–æ–∫—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª–æ (–æ—Å–Ω–æ–≤–Ω—É—é –æ—Ü–µ–Ω–∫—É) –∏ –∫–æ–Ω–µ—Ü (–∏—Å—Ç–æ—á–Ω–∏–∫–∏)
    beginning_length = MAX_MESSAGE_LENGTH // 2
    ending_length = MAX_MESSAGE_LENGTH - beginning_length - 140  # 140 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–∏
    
    beginning = text[:beginning_length]
    ending = text[-ending_length:]
    
    shortened_message = (
        f"{beginning}\n\n"
        f"[...—Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–æ –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Telegram...]\n\n"
        f"{ending}"
    )
    
    return await update.message.reply_text(shortened_message)

async def analyze_news_text(text: str) -> dict:
    """–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–æ–≤–æ—Å—Ç–∏ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—Ü–µ–Ω–∫–∏"""
    truncated_text = text[:1500] + ("..." if len(text) > 1500 else "") # –û–±—Ä–µ–∑–∫–∞ –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    
    prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º –∏ –≤–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ:
{{
  "textual_credibility_score": 0-100,
  "language_assessment": "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π/–º–∞–Ω–∏–ø—É–ª—è—Ç–∏–≤–Ω—ã–π –∏ –ø–æ—á–µ–º—É",
  "internal_consistency": "–æ—Ü–µ–Ω–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ª–æ–≥–∏–∫–∏ –∏ –Ω–µ–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–æ—Å—Ç–∏",
  "specificity": "–æ—Ü–µ–Ω–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏ (–¥–∞—Ç—ã, –∏–º–µ–Ω–∞, —Ü–∏—Ñ—Ä—ã)",
  "sources_cited": "–∞–Ω–∞–ª–∏–∑ —É–ø–æ–º–∏–Ω–∞–µ–º—ã—Ö –≤ —Ç–µ–∫—Å—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤",
  "balance": "–æ—Ü–µ–Ω–∫–∞ –±–∞–ª–∞–Ω—Å–∞ —Ç–æ—á–µ–∫ –∑—Ä–µ–Ω–∏—è",
  "conclusion": "–∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –æ–± –æ–±—â–µ–π –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞"
}}

–¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏: {truncated_text}
"""
    try:
        resp = ollama.generate(
            model='yandex/YandexGPT-5-Lite-8B-instruct-GGUF',
            prompt=prompt,
            format='json',
            options={'temperature': 0.1, 'num_ctx': 8192}
        )
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ JSON
        raw = resp['response'].strip().replace('```json', '').replace('```', '')
        try:
            result = json.loads(raw)
        except json.JSONDecodeError:
            import json_repair
            result = json.loads(json_repair.repair_json(raw))
            
        return result
    except Exception as err:
        logger.error(f"–û—à–∏–±–∫–∞ analyze_news_text: {err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        return {
            "textual_credibility_score": 50,
            "language_assessment": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å",
            "internal_consistency": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å",
            "specificity": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å",
            "sources_cited": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å",
            "balance": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å",
            "conclusion": "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–æ–≤–æ—Å—Ç–∏."
        } # –í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

async def generate_comprehensive_assessment(text_analysis, facts, fact_results, sources_quality, factcheck_results):
    """–°–æ–∑–¥–∞–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–∫—Ç–æ–≤ –∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"""
    data = {
        "text_analysis": text_analysis,
        "facts": facts,
        "fact_results": fact_results,
        "sources_quality": sources_quality,
        "factcheck_results": factcheck_results
    }
    
    data_str = json.dumps(data, ensure_ascii=False)
    prompt = f"""
–°–æ–∑–¥–∞–π –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ—Ü–µ–Ω–∫—É –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –Ω–æ–≤–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π Markdown
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π ** ## –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–æ–≤ –∏ –∞–±–∑–∞—Ü–µ–≤ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ ‚Ä¢ –∏–ª–∏ - –¥–ª—è –ø—É–Ω–∫—Ç–æ–≤ –∏ –ó–ê–ì–õ–ê–í–ù–´–ï –±—É–∫–≤—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤

1. –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ (—Å—Ç–∏–ª—å, –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –Ω–µ–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–æ—Å—Ç—å)
2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–æ–≤ –ø–æ –≤–Ω–µ—à–Ω–∏–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º
3. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Ñ–∞–∫—Ç–æ–≤ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ (fact-checking)
4. –ö–∞—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

–û—Å–æ–±–µ–Ω–Ω–æ —É—á–∏—Ç—ã–≤–∞–π:
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç—Å—è –ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã –Ω–∞–¥–µ–∂–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
- –ï—Å—Ç—å –ª–∏ –∏—Å–∫–∞–∂–µ–Ω–∏—è, –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ –∏–ª–∏ –ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω–∏—è
- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –ª–∏ —Ñ–∞–∫—Ç—ã –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- –°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

–í–µ—Ä–Ω–∏ –æ—Ç—á–µ—Ç –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
- üì∂ –û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê –î–û–°–¢–û–í–ï–†–ù–û–°–¢–ò: —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100 –∏–∑ 100
[–æ–±—è–∑—è—Ç–µ–ª—å–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ—É—é —Å—Ç—Ä–æ–∫—É —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º —Å—Ç—Ä–æ–∫–∏]

- üî∞ –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –§–ê–ö–¢–ê–ú: –æ—Ü–µ–Ω–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Å —Ñ–∞–∫—Ç–∞–º–∏ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
[–æ–±—è–∑—è—Ç–µ–ª—å–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ—É—é —Å—Ç—Ä–æ–∫—É —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º —Å—Ç—Ä–æ–∫–∏]

- üí≠ –í–´–í–û–î: –æ–±—â–µ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –æ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
[–æ–±—è–∑—è—Ç–µ–ª—å–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ—É—é —Å—Ç—Ä–æ–∫—É —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º —Å—Ç—Ä–æ–∫–∏]

- ‚úÖ –°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´: —Å–ø–∏—Å–æ–∫ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –Ω–æ–≤–æ—Å—Ç–∏
[–æ–±—è–∑—è—Ç–µ–ª—å–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ—É—é —Å—Ç—Ä–æ–∫—É —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º —Å—Ç—Ä–æ–∫–∏]

- ‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ù–´–ï –ú–ï–°–¢–ê: —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–±–ª–µ–º —Å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å—é
[–æ–±—è–∑—è—Ç–µ–ª—å–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ—É—é —Å—Ç—Ä–æ–∫—É —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º —Å—Ç—Ä–æ–∫–∏]

–î–∞–Ω–Ω—ã–µ: {data_str}
"""
    try:
        resp = ollama.generate(
            model='yandex/YandexGPT-5-Lite-8B-instruct-GGUF',
            prompt=prompt,
            options={'temperature': 0.1, 'num_ctx': 8192}
        )
        return remove_thinking_tags(resp['response']) # –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –º—ã—à–ª–µ–Ω–∏—è
    except Exception as err:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ comprehensive_assessment: {err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ—Ü–µ–Ω–∫—É." # –í–æ–∑–≤—Ä–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ

async def evaluate_sources_quality(fact_results: dict) -> dict:
    """–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"""
    sources_assessment = {}
    
    for fact, sources in fact_results.items():
        if not sources:
            sources_assessment[fact] = {
                "reliability_score": 0,
                "sources_count": 0,
                "authoritative_sources": False,
                "consensus": "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö",
                "summary": "–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
            }
            continue
        
        # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        sources_data = []
        for src in sources:
            url = src.get('url', '')
            title = src.get('title', '')
            snippet = src.get('snippet', '')
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è LLM
            sources_data.append({
                'url': url,
                'title': title,
                'snippet': snippet[:150]
            })
        
        # –û—Ü–µ–Ω–∏–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å –ø–æ–º–æ—â—å—é LLM
        prompt = f"""
–û—Ü–µ–Ω–∏ –∫–∞—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–∫—Ç–∞: "{fact}"

–î–∞–Ω–Ω—ã–µ:
{json.dumps(sources_data, ensure_ascii=False)}

–í–µ—Ä–Ω–∏ –æ—Ü–µ–Ω–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
  "reliability_score": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100 –∏–∑ 100,
  "sources_count": –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤,
  "authoritative_sources": true/false - –µ—Å—Ç—å –ª–∏ —Å—Ä–µ–¥–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –°–ú–ò/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏,
  "consensus": "—Å–æ–≥–ª–∞—Å—É—é—Ç—Å—è –ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –º–µ–∂–¥—É —Å–æ–±–æ–π",
  "summary": "–∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –æ –∫–∞—á–µ—Å—Ç–≤–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"
}}
"""
        try:
            resp = ollama.generate(
                model='yandex/YandexGPT-5-Lite-8B-instruct-GGUF',
                prompt=prompt,
                format='json',
                options={'temperature': 0.1, 'num_ctx': 8192}
            )
            
            raw = resp['response'].strip().replace('```json', '').replace('```', '')
            try:
                assessment = json.loads(raw)
            except json.JSONDecodeError:
                import json_repair
                assessment = json.loads(json_repair.repair_json(raw))
                
            sources_assessment[fact] = assessment # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏
        except Exception as err:
            logger.error(f"–û—à–∏–±–∫–∞ evaluate_sources_quality: {err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
            sources_assessment[fact] = {
                "reliability_score": 30,
                "sources_count": len(sources),
                "authoritative_sources": False,
                "consensus": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å",
                "summary": "–í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"
            } # –í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    
    return sources_assessment

async def perform_factchecking(user_text, facts, fact_results):
    """–í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–∞–∫—Ç–æ–≤ –∏–∑ –Ω–æ–≤–æ—Å—Ç–∏ –∏ –∏—Ö —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏"""
    
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    factcheck_data = {
        "original_text": user_text[:1000],
        "facts_to_check": facts,
        "sources_data": fact_results
    }
    
    data_str = json.dumps(factcheck_data, ensure_ascii=False)
    
    prompt = f"""
–í—ã–ø–æ–ª–Ω–∏ –¥–µ—Ç–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–∞–∫—Ç–æ–≤ (fact-checking) –º–µ–∂–¥—É —Ç–µ–∫—Å—Ç–æ–º –Ω–æ–≤–æ—Å—Ç–∏ –∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏.
–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–∫—Ç–∞ –æ—Ü–µ–Ω–∏:


[ üåê ]
1. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è –ª–∏ —Ñ–∞–∫—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ (–ø–æ–ª–Ω–æ—Å—Ç—å—é/—á–∞—Å—Ç–∏—á–Ω–æ/–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è/–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç)
2. –¢–æ—á–Ω–æ—Å—Ç—å –∏–∑–ª–æ–∂–µ–Ω–∏—è —Ñ–∞–∫—Ç–∞ –≤ –Ω–æ–≤–æ—Å—Ç–∏ (–∏—Å–∫–∞–∂–µ–Ω/–ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω/–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω)
3. –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ñ–∞–∫—Ç–∞ (–ø–æ–ª–Ω—ã–π/–Ω–µ–ø–æ–ª–Ω—ã–π/–≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
  "factcheck_results": [
    {{
      "fact": "–ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–π —Ñ–∞–∫—Ç",
      "confirmation_status": "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω/—á–∞—Å—Ç–∏—á–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω/–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω/–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º",
      "accuracy": "—Ç–æ—á–Ω–æ/—Å –∏—Å–∫–∞–∂–µ–Ω–∏—è–º–∏/—Å –ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω–∏—è–º–∏",
      "context_completeness": "–ø–æ–ª–Ω—ã–π/–Ω–µ–ø–æ–ª–Ω—ã–π/–≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞",
      "explanation": "–∫—Ä–∞—Ç–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏"
    }},
    // –¥—Ä—É–≥–∏–µ —Ñ–∞–∫—Ç—ã...
  ],
  "overall_factcheck_score": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100,
  "overall_assessment": "–æ–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ñ–∞–∫—Ç–æ–≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º"
}}

–î–∞–Ω–Ω—ã–µ: {data_str}
"""
    
    try:
        resp = ollama.generate(
            model='yandex/YandexGPT-5-Lite-8B-instruct-GGUF',
            prompt=prompt,
            format='json',
            options={'temperature': 0.1, 'num_ctx': 8192}
        )
        
        raw = resp['response'].strip().replace('```json', '').replace('```', '')
        try:
            result = json.loads(raw)
        except json.JSONDecodeError:
            import json_repair
            result = json.loads(json_repair.repair_json(raw))
            
        return result # –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    except Exception as err:
        logger.error(f"–û—à–∏–±–∫–∞ perform_factchecking: {err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        return {
            "factcheck_results": [
                {
                    "fact": "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏",
                    "confirmation_status": "–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
                    "accuracy": "–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
                    "context_completeness": "–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
                    "explanation": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ñ–∞–∫—Ç–æ–≤"
                }
            ],
            "overall_factcheck_score": 50,
            "overall_assessment": "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–∞–∫—Ç–æ–≤" # –í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        }

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π"""
    logger.error("–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞", exc_info=context.error) # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–∏
    
    # –ï—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ, —Å–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –ø—Ä–æ–±–ª–µ–º–µ
    if update and update.effective_message:
        await update.effective_message.reply_text(
            "üö® –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        ) # –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ
    # –Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —á–∞—Ç –∏–ª–∏ –∫–∞–Ω–∞–ª

if __name__ == '__main__':
    app = Application.builder().token(TELEGRAM_TOKEN).build() # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫—Ä–æ–º–µ –∫–æ–º–∞–Ω–¥
    app.add_handler(MessageHandler(filters.ALL & ~filters.COMMAND, handle_message))
    app.add_error_handler(error_handler) # –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫

    logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω")
    app.run_polling() # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –æ–ø—Ä–æ—Å–∞
