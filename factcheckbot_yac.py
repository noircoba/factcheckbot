# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
import logging # –î–ª—è –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã (–ø–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –∏ —Å–æ–±—ã—Ç–∏—è)
from telegram import Update # –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
from telegram.ext import Application, MessageHandler, filters, ContextTypes # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ Telegram
from telegram.helpers import escape_markdown # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è Telegram-—Å–æ–æ–±—â–µ–Ω–∏–π
import requests # HTTP-–∑–∞–ø—Ä–æ—Å—ã –∫ API
import json # –†–∞–±–æ—Ç–∞ —Å JSON-–¥–∞–Ω–Ω—ã–º–∏
import ollama # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ LLM (Large Language Model)
from bs4 import BeautifulSoup # –ü–∞—Ä—Å–∏–Ω–≥ HTML/XML –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
from bs4 import XMLParsedAsHTMLWarning # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ BeautifulSoup
import warnings # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏
import asyncio # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
from urllib.parse import urlparse # –ü–∞—Ä—Å–∏–Ω–≥ URL
import time # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –∏ –∏–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
from random import uniform # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ñ–ª—É–¥–∞
import re # –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
from collections import defaultdict # –î–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏
from datetime import datetime, timedelta # –†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–≤–æ–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
from config import (
    TELEGRAM_TOKEN, 
    YANDEX_USER,
    YANDEX_API_KEY,
    YANDEX_FOLDER_ID,
    YANDEX_SEARCH_URL
) # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è Telegram –∏ Yandex Search API

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Ollama
ollama.pull('yandex/YandexGPT-5-Lite-8B-instruct-GGUF') # –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏ LLM –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ñ–∞–∫—Ç–æ–≤

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
) # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã
logger = logging.getLogger(__name__) # –õ–æ–≥–≥–µ—Ä –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–æ–¥—É–ª—è

# –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è XMLParsedAsHTMLWarning
warnings.filterwarnings('ignore', category=XMLParsedAsHTMLWarning) # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ HTML

# –ö–ª–∞—Å—Å –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è —Ñ–ª—É–¥–∞
class FloodControl:
    def __init__(self, max_requests_per_hour=15):
        self.max_requests = max_requests_per_hour
        self.user_requests = defaultdict(list)  # {user_id: [timestamp1, timestamp2, ...]}
    
    def check_user(self, user_id):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å"""
        now = datetime.now()
        user_requests = self.user_requests[user_id]
        
        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã (—Å—Ç–∞—Ä—à–µ —á–∞—Å–∞)
        user_requests[:] = [req_time for req_time in user_requests 
                           if now - req_time < timedelta(hours=1)]
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
        if len(user_requests) >= self.max_requests:
            return False
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å
        user_requests.append(now)
        return True
    
    def get_remaining_requests(self, user_id):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤"""
        now = datetime.now()
        user_requests = self.user_requests[user_id]
        
        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã
        user_requests[:] = [req_time for req_time in user_requests 
                           if now - req_time < timedelta(hours=1)]
        
        return max(0, self.max_requests - len(user_requests))

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–æ–Ω—Ç—Ä–æ–ª—è —Ñ–ª—É–¥–∞
flood_control = FloodControl(max_requests_per_hour=15)

def handle_api_error(code: str, message: str) -> list:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ API"""
    error_map = {
        '42': '–ù–µ–≤–µ—Ä–Ω—ã–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ',
        '32': '–ü—Ä–µ–≤—ã—à–µ–Ω–∞ –∫–≤–æ—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤',
        '55': '–ü—Ä–µ–≤—ã—à–µ–Ω–æ RPS-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ',
        '15': '–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞'
    } # –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫ —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
    
    return [{
        'title': error_map.get(code, '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API'),
        'url': 'https://yandex.cloud/ru/docs/search-api/reference/error-codes',
        'snippet': f'–ö–æ–¥ {code}: {message}'
    }] # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å –æ—à–∏–±–∫–æ–π –∏ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

async def analyze_facts(text: str) -> dict:
    """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º"""
    prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –Ω–æ–≤–æ—Å—Ç–Ω–æ–π —Ç–µ–∫—Å—Ç –∏ –≤—ã–¥–µ–ª–∏ –∏–∑ –Ω–µ–≥–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ —Ñ–∞–∫—Ç—ã –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏.
–¢–û–õ–¨–ö–û —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï–ü–û–°–†–ï–î–°–¢–í–ï–ù–ù–û –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–º–µ –Ω–æ–≤–æ—Å—Ç–∏.

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –§–ê–ö–¢–ê–ú:
1. –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ü–û–õ–ù–´–ô –∫–æ–Ω—Ç–µ–∫—Å—Ç:
   - –ß–¢–û –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ (—Ç–æ—á–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ/–∑–∞—è–≤–ª–µ–Ω–∏–µ/–¥–µ–π—Å—Ç–≤–∏–µ)
   - –ì–î–ï —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ (—Ç–æ—á–Ω–∞—è –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞)
   - –ö–û–ì–î–ê —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ (—Ç–æ—á–Ω–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω—ã)
   - –ö–¢–û —É—á–∞—Å—Ç–≤–æ–≤–∞–ª/—Å–æ–æ–±—â–∏–ª/–∑–∞—è–≤–∏–ª (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–º–µ–Ω–∞, –¥–æ–ª–∂–Ω–æ—Å—Ç–∏, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏)
   - –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –î–ï–¢–ê–õ–ò (—Ü–∏—Ñ—Ä—ã, —Å—É–º–º—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞, —É—Å–ª–æ–≤–∏—è)

2. –í–∫–ª—é—á–∞–π –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã: "15 –Ω–æ—è–±—Ä—è 2024 –≥–æ–¥–∞", "–≤ 14:30 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏", "–≤—á–µ—Ä–∞", "–Ω–∞ –ø—Ä–æ—à–ª–æ–π –Ω–µ–¥–µ–ª–µ"

3. –°–æ—Ö—Ä–∞–Ω—è–π –≤—Å–µ —á–∏—Å–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –∏–º–µ–Ω–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ, –Ω–∞–∑–≤–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π, –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è

4. –§–æ—Ä–º—É–ª–∏—Ä—É–π —Ñ–∞–∫—Ç—ã –∫–∞–∫ –°–ê–ú–û–°–¢–û–Ø–¢–ï–õ–¨–ù–´–ï –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –ø–æ–Ω—è—Ç–Ω—ã–µ –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏—Å—Ö–æ–¥–Ω–æ–π —Å—Ç–∞—Ç—å–∏

5. –ù–ï –≤–∫–ª—é—á–∞–π:
   - –û—Ü–µ–Ω–æ—á–Ω—ã–µ —Å—É–∂–¥–µ–Ω–∏—è –∏ –º–Ω–µ–Ω–∏—è
   - –û–±—â–∏–µ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è
   - –§–∞–∫—Ç—ã, –Ω–µ –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–º–µ –Ω–æ–≤–æ—Å—Ç–∏
   - –í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

6. –°–æ–±–µ—Ä–∏ –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏ –∫–∞–∫ —Ç–æ: –ß–¢–û, –ì–î–ï, –ö–û–ì–î–ê, –ö–¢–û –∏ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –î–ï–¢–ê–õ–ò –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É –∏ –∏—Å–ø–æ–ª—å–∑—É–π –µ–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–∞–∂–¥—ã–π —Ñ–∞–∫—Ç

7. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ —Ñ–∞–∫—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–∞–∫ —Ç–æ: –ß–¢–û, –ì–î–ï, –ö–û–ì–î–ê, –ö–¢–û –∏ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –î–ï–¢–ê–õ–ò, –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ –æ–±–æ–≥–∞—Ç–∏ —Ñ–∞–∫—Ç –∏–º–∏

–ü–†–ò–ú–ï–† –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ì–û –∏–∑–≤–ª–µ—á–µ–Ω–∏—è (–º–∞–ª–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞):
"–ü—Ä–æ–∏–∑–æ—à–ª–æ –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–µ"
"–ó–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–µ –±—ã–ª–æ —Å–∏–ª—å–Ω—ã–º"

–ü–†–ò–ú–ï–† –ü–†–ê–í–ò–õ–¨–ù–û–ì–û –∏–∑–≤–ª–µ—á–µ–Ω–∏—è (–ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç):
"15 –Ω–æ—è–±—Ä—è 2024 –≥–æ–¥–∞ –≤ 11:27 –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–∏–∑–æ—à–ª–æ –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏–µ –º–∞–≥–Ω–∏—Ç—É–¥–æ–π 4.2 –±–∞–ª–ª–∞ –≤ —Ä–∞–π–æ–Ω–µ –≤–æ–¥–æ–ø–∞–¥–∞ –£—á–∞–Ω-–°—É –≤ –ö—Ä—ã–º—É, –ø–æ –¥–∞–Ω–Ω—ã–º –∑–∞–º–¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –ò–Ω—Å—Ç–∏—Ç—É—Ç–∞ —Å–µ–π—Å–º–æ–ª–æ–≥–∏–∏ –∏ –≥–µ–æ–¥–∏–Ω–∞–º–∏–∫–∏ –ú–∞—Ä–∏–Ω—ã –ë–æ–Ω–¥–∞—Ä—å"
"–≠–ø–∏—Ü–µ–Ω—Ç—Ä –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏—è 15 –Ω–æ—è–±—Ä—è 2024 –≥–æ–¥–∞ –Ω–∞—Ö–æ–¥–∏–ª—Å—è –Ω–∞ –≥–ª—É–±–∏–Ω–µ 10 –∫–∏–ª–æ–º–µ—Ç—Ä–æ–≤ –ø–æ–¥ –∑–µ–º–ª—ë–π –≤ —Ä–∞–π–æ–Ω–µ –≤–æ–¥–æ–ø–∞–¥–∞ –£—á–∞–Ω-–°—É –≤ –ö—Ä—ã–º—É, —Å–æ–≥–ª–∞—Å–Ω–æ –¥–∞–Ω–Ω—ã–º —Å–µ–π—Å–º–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å–ª—É–∂–±—ã"

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π:
{{
    "facts": ["–ø–æ–ª–Ω—ã–π —Ñ–∞–∫—Ç 1 —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º", "–ø–æ–ª–Ω—ã–π —Ñ–∞–∫—Ç 2 —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º", ...]
}}

–¢–µ–∫—Å—Ç: {text[:2500]}
"""
    logger.info(f"LLM Fact Extraction: {text[:350]!r}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    try:
        resp = ollama.generate(
            model='yandex/YandexGPT-5-Lite-8B-instruct-GGUF',
            prompt=prompt,
            format='json',
            options={'temperature': 0.1, 'num_ctx': 16384}
        ) # –í—ã–∑–æ–≤ LLM —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
        raw = resp['response'].strip().replace('```json', '').replace('```', '') # –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ JSON
        try:
            return json.loads(raw) # –ü–∞—Ä—Å–∏–Ω–≥ JSON-–æ—Ç–≤–µ—Ç–∞
        except json.JSONDecodeError:
            import json_repair # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è JSON
            return json.loads(json_repair.repair_json(raw)) # –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å JSON
    except Exception as err:
        logger.error(f"–û—à–∏–±–∫–∞ analyze_facts: {err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        return {"facts": []} # –í–æ–∑–≤—Ä–∞—Ç –ø—É—Å—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Ñ–∞–∫—Ç–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

async def yandex_factcheck(fact: str) -> list:
    """–ü–æ–∏—Å–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ Yandex Search API"""
    try:
        original_fact = fact
        logger.info(f"–ü–æ–∏—Å–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è —Ñ–∞–∫—Ç–∞: '{original_fact}'") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–∫—Ç–∞
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º XML –∑–∞–ø—Ä–æ—Å —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        request_xml = f"""<?xml version="1.0" encoding="UTF-8"?>
        <request>
            <query>{original_fact}</query>
            <page>0</page>
            <sortby order="descending">rlv</sortby>
            <maxpassages>3</maxpassages>
            <groupings>
                <groupby attr="d" mode="deep" groups-on-page="10" docs-in-group="1"/>
            </groupings>
        </request>
        """
        
        # –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        params = {
            'folderid': YANDEX_FOLDER_ID,  # –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–∞—Ç–∞–ª–æ–≥–∞
            'apikey': YANDEX_API_KEY,      # API-–∫–ª—é—á —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
            'type': 'xml'                  # –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
        }
        
        headers = {
            'Content-Type': 'application/xml',
            'Accept': 'application/xml'
        }

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–π API endpoint
        api_url = 'https://yandex.ru/search/xml' # URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤
        
        logger.info(f"–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Yandex Search API: {original_fact[:150]}...") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
        await asyncio.sleep(uniform(0.7, 1.2)) # –†–∞–Ω–¥–æ–º–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —Ñ–ª—É–¥–∞
        
        response = requests.post(
            api_url,
            params=params,
            data=request_xml.encode('utf-8'),
            headers=headers,
            timeout=15
        ) # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API
        
        response.raise_for_status() # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—à–∏–±–∫–∏ HTTP
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
        xml_soup = BeautifulSoup(response.text, 'xml') # –ü–∞—Ä—Å–∏–Ω–≥ XML
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API
        if error := xml_soup.find('error'):
            error_code = error.get('code', 'unknown')
            logger.error(f"–û—à–∏–±–∫–∞ API (–∫–æ–¥ {error_code}): {error.text}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ API
            return handle_api_error(error_code, error.text) # –í–æ–∑–≤—Ä–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–π –æ—à–∏–±–∫–∏
        
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        results = []
        for doc in xml_soup.find_all('doc'):
            try:
                url = doc.find('url').text.strip()
                title = doc.find('title').text.strip() if doc.find('title') else "–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞"
                snippet = ' '.join([p.text for p in doc.find_all('passage')][:3]) # –ë–æ–ª—å—à–µ –æ—Ç—Ä—ã–≤–∫–æ–≤
        
                results.append({
                    'title': title[:250],
                    'url': url,
                    'snippet': snippet[:500]  # –†–∞–∑–º–µ—Ä –æ—Ç—Ä—ã–≤–∫–∞
                })
            except Exception as doc_err:
                logger.warning(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞: {doc_err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

        return results if results else [{
            'title': '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞',
            'url': '',
            'snippet': f'–ü–æ –∑–∞–ø—Ä–æ—Å—É "{original_fact}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'
        }] # –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–µ—É–¥–∞—á–µ
        
    except Exception as err:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {err}", exc_info=True) # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
        return [{
            'title': '–û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã',
            'url': '',
            'snippet': '–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ'
        }] # –í–æ–∑–≤—Ä–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Å–∏—Å—Ç–µ–º–Ω–æ–π –æ—à–∏–±–∫–µ

async def analyze_news_text(text: str) -> dict:
    """–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–æ–≤–æ—Å—Ç–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞"""
    truncated_text = text[:3000] + ("..." if len(text) > 3000 else "") # –û–±—Ä–µ–∑–∫–∞ –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
    
    prompt = f"""
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏ –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –ø—Ä–∏–∑–Ω–∞–∫–∞–º –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∏–∫–∏:

–ö–†–ò–¢–ï–†–ò–ò –ê–ù–ê–õ–ò–ó–ê:
1. –°–¢–ò–õ–¨ –ò –Ø–ó–´–ö:
   - –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π/–æ–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π vs —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –æ–∫—Ä–∞—à–µ–Ω–Ω—ã–π/–º–∞–Ω–∏–ø—É–ª—è—Ç–∏–≤–Ω—ã–π
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤ vs –æ—Ü–µ–Ω–æ—á–Ω—ã—Ö —Å—É–∂–¥–µ–Ω–∏–π
   - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏–∑–ª–æ–∂–µ–Ω–∏—è

2. –í–ù–£–¢–†–ï–ù–ù–Ø–Ø –°–û–ì–õ–ê–°–û–í–ê–ù–ù–û–°–¢–¨:
   - –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—è –≤–Ω—É—Ç—Ä–∏ —Ç–µ–∫—Å—Ç–∞
   - –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä–∞–º–æ–∫
   - –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π

3. –ö–û–ù–ö–†–ï–¢–ù–û–°–¢–¨ –ò –î–ï–¢–ê–õ–ò–ó–ê–¶–ò–Ø:
   - –ù–∞–ª–∏—á–∏–µ —Ç–æ—á–Ω—ã—Ö –¥–∞—Ç, –≤—Ä–µ–º–µ–Ω–∏, –º–µ—Å—Ç
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–º–µ–Ω–∞, –¥–æ–ª–∂–Ω–æ—Å—Ç–∏, –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
   - –¢–æ—á–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

4. –ò–°–¢–û–ß–ù–ò–ö–ò –ò –°–°–´–õ–ö–ò:
   - –£–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
   - –ê–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω–æ—Å—Ç—å —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
   - –ü—Ä—è–º—ã–µ —Ü–∏—Ç–∞—Ç—ã vs –ø–µ—Ä–µ—Å–∫–∞–∑

5. –ë–ê–õ–ê–ù–° –ò –û–ë–™–ï–ö–¢–ò–í–ù–û–°–¢–¨:
   - –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ç–æ—á–µ–∫ –∑—Ä–µ–Ω–∏—è
   - –ò–∑–±–µ–≥–∞–Ω–∏–µ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–æ—Å—Ç–∏
   - –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤ –∏ –º–Ω–µ–Ω–∏–π

6. –ü–†–ò–ó–ù–ê–ö–ò –î–ï–ó–ò–ù–§–û–†–ú–ê–¶–ò–ò:
   - –°–µ–Ω—Å–∞—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±–µ–∑ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤
   - –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –≤–º–µ—Å—Ç–æ —Ñ–∞–∫—Ç–æ–≤
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ JSON:
{{
  "credibility_score": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100,
  "style_analysis": "–æ—Ü–µ–Ω–∫–∞ —Å—Ç–∏–ª—è –∏ —è–∑—ã–∫–∞",
  "logical_consistency": "–æ—Ü–µ–Ω–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –ª–æ–≥–∏–∫–∏",
  "specificity_level": "—É—Ä–æ–≤–µ–Ω—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—Å—Ç–∏", 
  "sources_quality": "–∞–Ω–∞–ª–∏–∑ —É–ø–æ–º—è–Ω—É—Ç—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤",
  "balance_assessment": "–æ—Ü–µ–Ω–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –∏ –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏",
  "manipulation_signs": "–æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏",
  "strong_points": ["—Å–ø–∏—Å–æ–∫ —Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω —Ç–µ–∫—Å—Ç–∞"],
  "weak_points": ["—Å–ø–∏—Å–æ–∫ —Å–ª–∞–±—ã—Ö –º–µ—Å—Ç"],
  "overall_conclusion": "–æ–±—â–∏–π –≤—ã–≤–æ–¥ –æ –∫–∞—á–µ—Å—Ç–≤–µ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏"
}}

–¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏: {truncated_text}
"""
    try:
        resp = ollama.generate(
            model='yandex/YandexGPT-5-Lite-8B-instruct-GGUF',
            prompt=prompt,
            format='json',
            options={'temperature': 0.1, 'num_ctx': 16384}
        )
        
        raw = resp['response'].strip().replace('```json', '').replace('```', '')
        try:
            result = json.loads(raw)
        except json.JSONDecodeError:
            import json_repair
            result = json.loads(json_repair.repair_json(raw))
            
        return result
    except Exception as err:
        logger.error(f"–û—à–∏–±–∫–∞ analyze_news_text: {err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        return {
            "credibility_score": 50,
            "style_analysis": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å",
            "logical_consistency": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å", 
            "specificity_level": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å",
            "sources_quality": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å",
            "balance_assessment": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ü–µ–Ω–∏—Ç—å",
            "manipulation_signs": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–∞—Ä—É–∂–∏—Ç—å",
            "strong_points": ["–ê–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"],
            "weak_points": ["–ê–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"],
            "overall_conclusion": "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–æ–≤–æ—Å—Ç–∏."
        } # –í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

def remove_thinking_tags(text):
    """–£–¥–∞–ª—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–µ–∂–¥—É —Ç–µ–≥–∞–º–∏ <think> –∏ </think>"""
    import re
    pattern = r'<think>.*?</think>' # –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –º—ã—à–ª–µ–Ω–∏—è
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º re.DOTALL, —á—Ç–æ–±—ã —Ç–æ—á–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ —Ç–∞–∫–∂–µ —Å–∏–º–≤–æ–ª–∞–º –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
    cleaned_text = re.sub(pattern, '', text, flags=re.DOTALL)
    return cleaned_text

def is_meaningful_text(text: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞"""
    clean_text = re.sub(r'\s+', ' ', re.sub(r'[^\w\s]', '', text)).strip() # –û—á–∏—Å—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –æ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
    return (
        len(clean_text) >= 16 and # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞
        len(set(clean_text.split())) >= 4 and # –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ —Å–ª–æ–≤
        any(c.isalpha() for c in clean_text) # –ù–∞–ª–∏—á–∏–µ –±—É–∫–≤
    )

async def perform_factchecking(user_text, facts, fact_results):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ñ–∞–∫—Ç–æ–≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤"""
    
    # –°–Ω–∞—á–∞–ª–∞ —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ñ–∞–∫—Ç—ã –Ω–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ –Ω–æ–≤–æ—Å—Ç–∏
    relevant_facts = await filter_relevant_facts(user_text, facts)
    
    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤
    factcheck_data = {
        "original_text": user_text[:3000],
        "relevant_facts": relevant_facts,
        "sources_data": {fact: fact_results[fact] for fact in relevant_facts if fact in fact_results}
    }
    
    data_str = json.dumps(factcheck_data, ensure_ascii=False)
    
    prompt = f"""
–í—ã–ø–æ–ª–Ω–∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–∞–∫—Ç–æ–≤ –º–µ–∂–¥—É —Ç–µ–∫—Å—Ç–æ–º –Ω–æ–≤–æ—Å—Ç–∏ –∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏.
–ê–ù–ê–õ–ò–ó–ò–†–£–ô –¢–û–õ–¨–ö–û –§–ê–ö–¢–´, –ö–û–¢–û–†–´–ï –ù–ï–ü–û–°–†–ï–î–°–¢–í–ï–ù–ù–û –û–¢–ù–û–°–Ø–¢–°–Ø –ö –û–°–ù–û–í–ù–û–ô –¢–ï–ú–ï –ù–û–í–û–°–¢–ò.

–î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–≥–æ —Ñ–∞–∫—Ç–∞ –ø—Ä–æ–≤–µ–¥–∏ –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É:

1. –°–û–û–¢–í–ï–¢–°–¢–í–ò–ï –ò–°–¢–û–ß–ù–ò–ö–ê–ú:
   - –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è (—Ñ–∞–∫—Ç —Ç–æ—á–Ω–æ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏)
   - –ß–∞—Å—Ç–∏—á–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è (–æ—Å–Ω–æ–≤–∞ —Ñ–∞–∫—Ç–∞ –≤–µ—Ä–Ω–∞, –Ω–æ –µ—Å—Ç—å –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏)
   - –ù–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç—Å—è (–∏—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)
   - –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º (–∏—Å—Ç–æ—á–Ω–∏–∫–∏ –æ–ø—Ä–æ–≤–µ—Ä–≥–∞—é—Ç —Ñ–∞–∫—Ç)

2. –¢–û–ß–ù–û–°–¢–¨ –ò–ó–õ–û–ñ–ï–ù–ò–Ø:
   - –¢–æ—á–Ω–æ (—Ñ–∞–∫—Ç –∏–∑–ª–æ–∂–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ)
   - –° –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–º–∏ –∏—Å–∫–∞–∂–µ–Ω–∏—è–º–∏ (–º–µ–ª–∫–∏–µ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏)
   - –° —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –∏—Å–∫–∞–∂–µ–Ω–∏—è–º–∏ (–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏)
   - –° –ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω–∏—è–º–∏ (—Ñ–∞–∫—Ç —Ä–∞–∑–¥—É—Ç –∏–ª–∏ –¥—Ä–∞–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω)

3. –ö–û–ù–¢–ï–ö–°–¢–ù–û–°–¢–¨:
   - –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–≤—Å—è –≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞)
   - –ù–µ–ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (—É–ø—É—â–µ–Ω—ã –≤–∞–∂–Ω—ã–µ –¥–µ—Ç–∞–ª–∏)
   - –í–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—Ñ–∞–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
   - –õ–æ–∂–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (—Ñ–∞–∫—Ç –ø–æ–º–µ—â–µ–Ω –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç)

4. –í–†–ï–ú–ï–ù–ù–ê–Ø –¢–û–ß–ù–û–°–¢–¨:
   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–±—ã—Ç–∏—è
   - –ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏
   - –°—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

–í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
  "factcheck_results": [
    {{
      "fact": "–ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–π —Ñ–∞–∫—Ç",
      "relevance_to_news": "–≤—ã—Å–æ–∫–∞—è/—Å—Ä–µ–¥–Ω—è—è/–Ω–∏–∑–∫–∞—è",
      "source_confirmation": "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω/—á–∞—Å—Ç–∏—á–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω/–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω/–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç",
      "accuracy_level": "—Ç–æ—á–Ω–æ/–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è/—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å–∫–∞–∂–µ–Ω–∏—è/–ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω–∏—è",
      "context_completeness": "–ø–æ–ª–Ω—ã–π/–Ω–µ–ø–æ–ª–Ω—ã–π/–≤–Ω–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞/–ª–æ–∂–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç",
      "temporal_accuracy": "—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç/–Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è/—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏",
      "source_count": —á–∏—Å–ª–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤,
      "confidence_score": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100,
      "explanation": "–æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏"
    }}
  ],
  "overall_factcheck_score": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100,
  "overall_assessment": "–æ–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ñ–∞–∫—Ç–æ–≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º",
  "methodology_notes": "–∑–∞–º–µ—Ç–∫–∏ –æ –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏"
}}

–î–∞–Ω–Ω—ã–µ: {data_str}
"""
    
    try:
        resp = ollama.generate(
            model='yandex/YandexGPT-5-Lite-8B-instruct-GGUF',
            prompt=prompt,
            format='json',
            options={'temperature': 0.05, 'num_ctx': 16384}  # –°–Ω–∏–∂–µ–Ω–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –±–æ–ª—å—à–µ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
        )
        
        raw = resp['response'].strip().replace('```json', '').replace('```', '')
        try:
            result = json.loads(raw)
        except json.JSONDecodeError:
            import json_repair
            result = json.loads(json_repair.repair_json(raw))
            
        return result # –í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    except Exception as err:
        logger.error(f"–û—à–∏–±–∫–∞ perform_factchecking: {err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        return {
            "factcheck_results": [
                {
                    "fact": "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏",
                    "relevance_to_news": "–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
                    "source_confirmation": "–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
                    "accuracy_level": "–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
                    "context_completeness": "–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
                    "temporal_accuracy": "–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ",
                    "source_count": 0,
                    "confidence_score": 0,
                    "explanation": "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ñ–∞–∫—Ç–æ–≤"
                }
            ],
            "overall_factcheck_score": 30,
            "overall_assessment": "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–∞–∫—Ç–æ–≤",
            "methodology_notes": "–ü—Ä–æ–≤–µ—Ä–∫–∞ –±—ã–ª–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞ –∏–∑-–∑–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏"
        }

async def filter_relevant_facts(text: str, facts: list) -> list:
    """–§–∏–ª—å—Ç—Ä—É–µ—Ç —Ñ–∞–∫—Ç—ã, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–º–µ –Ω–æ–≤–æ—Å—Ç–∏"""
    
    prompt = f"""
–û–ø—Ä–µ–¥–µ–ª–∏, –∫–∞–∫–∏–µ –∏–∑ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –ù–ï–ü–û–°–†–ï–î–°–¢–í–ï–ù–ù–û –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–º–µ –Ω–æ–≤–æ—Å—Ç–∏.
–ò–°–ö–õ–Æ–ß–ò —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ:
- –Ø–≤–ª—è—é—Ç—Å—è –æ–±—â–∏–º–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è–º–∏
- –û—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –ø–æ–±–æ—á–Ω—ã–º —Ç–µ–º–∞–º
- –ù–µ —Å–≤—è–∑–∞–Ω—ã —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏
- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–µ —è–≤–ª—è—é—â—É—é—Å—è –∫–ª—é—á–µ–≤–æ–π –¥–ª—è –Ω–æ–≤–æ—Å—Ç–∏

–û—Å—Ç–∞–≤—å —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ:
- –ù–∞–ø—Ä—è–º—É—é –æ–ø–∏—Å—ã–≤–∞—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–æ–≤–æ—Å—Ç–∏
- –°–æ–¥–µ—Ä–∂–∞—Ç –∫–ª—é—á–µ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å—É—Ç–∏ –Ω–æ–≤–æ—Å—Ç–∏
- –Ø–≤–ª—è—é—Ç—Å—è –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–º–∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è–º–∏ –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ–∞–∫—Ç–∞—Ö

–¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏: {text[:1000]}

–§–∞–∫—Ç—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:
{json.dumps(facts, ensure_ascii=False)}

–í–µ—Ä–Ω–∏ JSON —Å–æ —Å–ø–∏—Å–∫–æ–º –¢–û–õ–¨–ö–û —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤:
{{
  "relevant_facts": ["—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π —Ñ–∞–∫—Ç 1", "—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–π —Ñ–∞–∫—Ç 2", ...]
}}
"""
    
    try:
        resp = ollama.generate(
            model='yandex/YandexGPT-5-Lite-8B-instruct-GGUF',
            prompt=prompt,
            format='json',
            options={'temperature': 0.1, 'num_ctx': 16384}
        )
        
        raw = resp['response'].strip().replace('```json', '').replace('```', '')
        try:
            result = json.loads(raw)
            return result.get('relevant_facts', facts)  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–∫—Ç—ã –µ—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞
        except json.JSONDecodeError:
            import json_repair
            result = json.loads(json_repair.repair_json(raw))
            return result.get('relevant_facts', facts)
            
    except Exception as err:
        logger.error(f"–û—à–∏–±–∫–∞ filter_relevant_facts: {err}")
        return facts  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–∫—Ç—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ

async def evaluate_sources_quality(fact_results: dict) -> dict:
    """–û—Ü–µ–Ω–∏–≤–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å –ø–æ–¥—Å—á–µ—Ç–æ–º"""
    sources_assessment = {}
    
    for fact, sources in fact_results.items():
        source_count = len(sources) if sources else 0
        
        if not sources:
            sources_assessment[fact] = {
                "reliability_score": 0,
                "sources_count": 0,
                "authoritative_sources": False,
                "consensus": "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö",
                "summary": "–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã",
                "top_source": None
            }
            continue
        
        # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        sources_data = []
        for src in sources:
            url = src.get('url', '')
            title = src.get('title', '')
            snippet = src.get('snippet', '')
            
            sources_data.append({
                'url': url,
                'title': title,
                'snippet': snippet[:250]
            })
        
        # –û—Ü–µ–Ω–∏–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å –ø–æ–º–æ—â—å—é LLM
        prompt = f"""
–û—Ü–µ–Ω–∏ –∫–∞—á–µ—Å—Ç–≤–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–∫—Ç–∞: "{fact}"

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: {source_count}

–î–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:
{json.dumps(sources_data, ensure_ascii=False)}

–í–µ—Ä–Ω–∏ –æ—Ü–µ–Ω–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
{{
  "reliability_score": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100,
  "sources_count": {source_count},
  "authoritative_sources": true/false - –µ—Å—Ç—å –ª–∏ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –°–ú–ò/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏,
  "consensus": "—Å–æ–≥–ª–∞—Å—É—é—Ç—Å—è –ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –º–µ–∂–¥—É —Å–æ–±–æ–π",
  "summary": "–∫—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥ –æ –∫–∞—á–µ—Å—Ç–≤–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤",
  "top_source_index": –∏–Ω–¥–µ–∫—Å (0-{len(sources_data)-1}) —Å–∞–º–æ–≥–æ –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞,
  "source_diversity": "–æ—Ü–µ–Ω–∫–∞ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è —Ç–∏–ø–æ–≤ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"
}}
"""
        try:
            resp = ollama.generate(
                model='yandex/YandexGPT-5-Lite-8B-instruct-GGUF',
                prompt=prompt,
                format='json',
                options={'temperature': 0.1, 'num_ctx': 16384}
            )
            
            raw = resp['response'].strip().replace('```json', '').replace('```', '')
            try:
                assessment = json.loads(raw)
            except json.JSONDecodeError:
                import json_repair
                assessment = json.loads(json_repair.repair_json(raw))
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ª—É—á—à–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ
            top_index = assessment.get('top_source_index', 0)
            if 0 <= top_index < len(sources):
                assessment['top_source'] = sources[top_index]
            else:
                assessment['top_source'] = sources[0] if sources else None
                
            sources_assessment[fact] = assessment # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ü–µ–Ω–∫–∏
        except Exception as err:
            logger.error(f"–û—à–∏–±–∫–∞ evaluate_sources_quality: {err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
            sources_assessment[fact] = {
                "reliability_score": 30,
                "sources_count": source_count,
                "authoritative_sources": False,
                "consensus": "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å",
                "summary": "–í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ü–µ–Ω–∫–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤",
                "top_source": sources[0] if sources else None,
                "source_diversity": "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"
            } # –í–æ–∑–≤—Ä–∞—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    
    return sources_assessment

async def generate_comprehensive_assessment(text_analysis, facts, fact_results, sources_quality, factcheck_results):
    """–°–æ–∑–¥–∞–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞"""
    
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    total_sources = sum(len(sources) for sources in fact_results.values())
    facts_with_sources = sum(1 for sources in fact_results.values() if sources)
    
    data = {
        "text_analysis": text_analysis,
        "facts": facts,
        "fact_results": fact_results,
        "sources_quality": sources_quality, 
        "factcheck_results": factcheck_results,
        "sources_statistics": {
            "total_sources_found": total_sources,
            "facts_with_sources": facts_with_sources,
            "total_facts_checked": len(facts)
        }
    }
    
    data_str = json.dumps(data, ensure_ascii=False)
    prompt = f"""
–°–æ–∑–¥–∞–π –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ—Ü–µ–Ω–∫—É –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç–∏ –Ω–æ–≤–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–∏–º–≤–æ–ª—ã *, **, ##, [], (), ~, `, >, #, +, -, =, |.

–ö–û–ú–ü–û–ù–ï–ù–¢–´ –ê–ù–ê–õ–ò–ó–ê:
1. –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–æ–≤–æ—Å—Ç–∏ (–ò—Å—Ç–æ—á–Ω–∏–∫ (–∏ –µ–≥–æ —Ä–µ–ø—É—Ç–∞—Ü–∏—è), –ª–æ–≥–∏–∫–∞, –Ω–µ–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–æ—Å—Ç—å, –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏, –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã(–¥–∞—Ç—ã, —É—á–∞—Å—Ç–Ω–∏–∫–∏, –ª–æ–∫–∞—Ü–∏–∏), –∫–∞—á–µ—Å—Ç–≤–æ –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∏–∫–∏)
2. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–æ–≤ –ø–æ –≤–Ω–µ—à–Ω–∏–º –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º  
3. –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤ —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
4. –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

–û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–∫—Ç–∞
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç—Å—è –ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã –Ω–∞–¥–µ–∂–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
- –ï—Å—Ç—å –ª–∏ –∏—Å–∫–∞–∂–µ–Ω–∏—è, –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ –∏–ª–∏ –ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω–∏—è
- –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –ª–∏ —Ñ–∞–∫—Ç—ã –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–º–µ

–í–µ—Ä–Ω–∏ –æ—Ç—á–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

üìä –û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê –î–û–°–¢–û–í–ï–†–ù–û–°–¢–ò: [—á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 100]

üîç –ê–ù–ê–õ–ò–ó –¢–ï–ö–°–¢–ê: [–æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Ç–µ–∫—Å—Ç–∞ –Ω–æ–≤–æ—Å—Ç–∏]

üìã –ü–†–û–í–ï–†–ö–ê –§–ê–ö–¢–û–í: [—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏]

üìö –ò–°–¢–û–ß–ù–ò–ö–ò: [—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –æ—Ü–µ–Ω–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ - –≤—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ, –∫–∞—á–µ—Å—Ç–≤–æ]

‚úÖ –ü–û–õ–û–ñ–ò–¢–ï–õ–¨–ù–´–ï –ê–°–ü–ï–ö–¢–´: [—Å–ø–∏—Å–æ–∫ —Å–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω]

‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ù–´–ï –ú–û–ú–ï–ù–¢–´: [—Å–ø–∏—Å–æ–∫ –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º]

üí≠ –ò–¢–û–ì–û–í–û–ï –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï: [—Ñ–∏–Ω–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ –æ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏]

–î–∞–Ω–Ω—ã–µ: {data_str}
"""
    try:
        resp = ollama.generate(
            model='yandex/YandexGPT-5-Lite-8B-instruct-GGUF',
            prompt=prompt,
            options={'temperature': 0.1, 'num_ctx': 16384}
        )
        return remove_thinking_tags(resp['response']) # –£–¥–∞–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –º—ã—à–ª–µ–Ω–∏—è
    except Exception as err:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ comprehensive_assessment: {err}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        return "–ù–µ —É–¥–∞–ª–æ—Å—å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ—Ü–µ–Ω–∫—É." # –í–æ–∑–≤—Ä–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ

async def anti_flood(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞—â–∏—Ç—ã –æ—Ç —Ñ–ª—É–¥–∞"""
    user_id = update.effective_user.id
    
    if not flood_control.check_user(user_id): # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–ª—É–¥ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
        remaining = flood_control.get_remaining_requests(user_id)
        logger.warning(f"–§–ª—É–¥-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        await update.message.reply_text(
            f"‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (15 –≤ —á–∞—Å).\n"
            f"–û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã: {remaining}\n" 
            f"–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ —á–∞—Å."
        )
        return True  # –ë–ª–æ–∫–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
    return False  # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∏ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω—Ç–∏—Ñ–ª—É–¥
        if await anti_flood(update, context):
            return

        user_text = update.message.text or update.message.caption

        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –ø–æ–¥–ø–∏—Å–∏ –∫ –º–µ–¥–∏–∞
        user_text = (
            update.message.text or 
            update.message.caption or 
            ''
        ).strip()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ–∫—Å—Ç–∞
        if not user_text:
            logger.debug("–ú–µ–¥–∏–∞-—Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞ –æ—Ç %s", update.effective_user.id)
            return

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞
        text_length = len(user_text)
        if text_length < 10:
            await update.message.reply_text("üìù –¢–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ú–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤.")
            return

        if len(user_text) > 2000:
            user_text = user_text[:2000] + "..." # –ª–∏–º–∏—Ç –¥–ª–∏–Ω–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è

        logger.info(f"Received from {update.effective_user.id}: {user_text[:120]!r}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã
        remaining = flood_control.get_remaining_requests(update.effective_user.id)
        
        processing_message = await update.message.reply_text(
            f"‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...\n"
            f"üìä –û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–ø—Ä–æ—Å—ã: {remaining}/15"
        )

        try:
            await context.bot.edit_message_text(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id,
                text="‚è≥ –í—ã–ø–æ–ª–Ω—è—é –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤..."
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        
        text_analysis_task = asyncio.create_task(analyze_news_text(user_text)) # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞
        facts_data = await analyze_facts(user_text)
        facts = facts_data.get('facts', [])[:6] # –ª–∏–º–∏—Ç —Ñ–∞–∫—Ç–æ–≤
        
        # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–∫—Ç–æ–≤
        try:
            await context.bot.edit_message_text(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id,
                text=f"‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é {len(facts)} –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤..."
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")
        
        fact_results = {fact: await yandex_factcheck(fact) for fact in facts} # –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏
        
        # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞
        try:
            await context.bot.edit_message_text(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id,
                text="‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∫–∞—á–µ—Å—Ç–≤–æ —Ç–µ–∫—Å—Ç–∞..."
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")
            
        text_analysis = await text_analysis_task
        
        # –û—Ü–µ–Ω–∏–≤–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        try:
            await context.bot.edit_message_text(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id,
                text="‚è≥ –û—Ü–µ–Ω–∏–≤–∞—é –∫–∞—á–µ—Å—Ç–≤–æ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤..."
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")

        sources_quality_task = asyncio.create_task(evaluate_sources_quality(fact_results)) # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –æ—Ü–µ–Ω–∫–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–∞–∫—Ç–æ–≤
        try:
            await context.bot.edit_message_text(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id,
                text="‚è≥ –í—ã–ø–æ–ª–Ω—è—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–∞–∫—Ç–æ–≤..."
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")

        factcheck_task = asyncio.create_task(perform_factchecking(user_text, facts, fact_results)) # –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–∫—Ç–æ–≤
        
        # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
        sources_quality = await sources_quality_task
        factcheck_results = await factcheck_task
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ—Ü–µ–Ω–∫—É
        try:
            await context.bot.edit_message_text(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id,
                text="‚è≥ –§–æ—Ä–º–∏—Ä—É—é –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Å —É—á–µ—Ç–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤..."
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")

        comprehensive_report = await generate_comprehensive_assessment(
            text_analysis, facts, fact_results, sources_quality, factcheck_results
        ) # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á—ë—Ç–∞
        
        # –û–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–π –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        combined_results = "\nüìë –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–†–û–í–ï–†–ö–ò:\n"
        total_sources = 0
        
        if "factcheck_results" in factcheck_results:
            for i, fact_check in enumerate(factcheck_results["factcheck_results"][:3], 1): # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
                fact = fact_check.get("fact", "")
                status = fact_check.get("source_confirmation", "")
                accuracy = fact_check.get("accuracy_level", "")
                sources_count = fact_check.get("source_count", 0)
                confidence = fact_check.get("confidence_score", 0)
                
                total_sources += sources_count
                
                combined_results += f"{i}. {fact[:150]}{'...' if len(fact) > 150 else ''}\n"
                combined_results += f"   –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: {status}\n"
                combined_results += f"   –¢–æ—á–Ω–æ—Å—Ç—å: {accuracy}, –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {confidence}%\n"
                combined_results += f"   –ò—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –Ω–∞–π–¥–µ–Ω–æ: {sources_count}\n"
                
                # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ø-–∏—Å—Ç–æ—á–Ω–∏–∫ –µ—Å–ª–∏ –µ—Å—Ç—å
                if fact in fact_results and fact_results[fact]:
                    top_source = fact_results[fact][0]
                    title = top_source.get('title', '–ë–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞')
                    url = top_source.get('url', '')
                    combined_results += f"   –¢–æ–ø-–∏—Å—Ç–æ—á–Ω–∏–∫: {title[:100]}{'...' if len(title) > 100 else ''}\n"
                    if url:
                        combined_results += f"   –°—Å—ã–ª–∫–∞: {url[:200]}{'...' if len(url) > 200 else ''}\n"
                combined_results += "\n"
        
        combined_results += f"üìä\n"
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç
        final_report = "\n".join([
            comprehensive_report[:3500],
            combined_results[:3500]
        ]) # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —á–∞—Å—Ç–µ–π –æ—Ç—á—ë—Ç–∞
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ
        try:
            await context.bot.delete_message(
                chat_id=update.effective_message.chat_id,
                message_id=processing_message.message_id
            )
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –æ–±—Ä–∞–±–æ—Ç–∫–µ: {e}") # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç
        await send_long_message(update, final_report) # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        
    except Exception as err:
        logger.error(f"–û—à–∏–±–∫–∞ handle_message: {err}", exc_info=True) # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
        await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞.")

async def send_long_message(update, text):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, —Å–æ–∫—Ä–∞—â–∞—è –µ–≥–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
    MAX_MESSAGE_LENGTH = 4000  # –ù–µ–º–Ω–æ–≥–æ –º–µ–Ω—å—à–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ –¥–ª—è –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∏
    
    # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ—Ä–æ—á–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ —Ü–µ–ª–∏–∫–æ–º
    if len(text) <= MAX_MESSAGE_LENGTH:
        return await update.message.reply_text(text)
    
    # –°–æ–∫—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
    beginning_length = MAX_MESSAGE_LENGTH // 2
    ending_length = MAX_MESSAGE_LENGTH - beginning_length - 150  # 150 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å–æ–∫—Ä–∞—â–µ–Ω–∏–∏
    
    beginning = text[:beginning_length]
    ending = text[-ending_length:]
    
    shortened_message = (
        f"{beginning}\n\n"
        f"[...—Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–æ –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Telegram...]\n\n"
        f"{ending}"
    )
    
    return await update.message.reply_text(shortened_message)

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏—Å–∫–ª—é—á–µ–Ω–∏–π"""
    logger.error("–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞", exc_info=context.error) # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ—à–∏–±–∫–∏
    
    # –ï—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ, —Å–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –ø—Ä–æ–±–ª–µ–º–µ
    if update and update.effective_message:
        await update.effective_message.reply_text(
            "üö® –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        ) # –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

if __name__ == '__main__':
    app = Application.builder().token(TELEGRAM_TOKEN).build() # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫—Ä–æ–º–µ –∫–æ–º–∞–Ω–¥
    app.add_handler(MessageHandler(filters.ALL & ~filters.COMMAND, handle_message))
    app.add_error_handler(error_handler) # –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫

    logger.info("–ë–æ—Ç —Ñ–∞–∫—Ç—á–µ–∫–∏–Ω–≥–∞ –∑–∞–ø—É—â–µ–Ω —Å –Ω–æ–≤—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏")
    app.run_polling() # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –æ–ø—Ä–æ—Å–∞
